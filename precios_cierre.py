# -*- coding: utf-8 -*-
"""Precios_cierre.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1O-NElF6Zovvfg5lWmUDm05kgUg9jQpPi
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import datetime as dt

st.image("UNRC.png", caption="Universidad Nacional Rosario Castellanos", width=300)

# --- Configuraci√≥n de la p√°gina ---
st.set_page_config(page_title="Precio de Cierre Mensual", page_icon="", layout="centered")

# --- T√≠tulo e instrucciones ---
st.title(" Precio de Cierre - √öltimo D√≠a H√°bil de Cada Mes")

st.markdown("""
Esta aplicaci√≥n obtiene el **precio de cierre del √∫ltimo d√≠a h√°bil de cada mes** 
de los √∫ltimos **5 a√±os**, usando datos de **Yahoo Finance**.

-Ejemplos de claves de pizarra:
- `AMXL.MX` ‚Üí Am√©rica M√≥vil  
- `CEMEXCPO.MX` ‚Üí Cemex  
""")

# --- Entrada del usuario ---
ticker = st.text_input("üîé Ingresa la clave de pizarra:", value="AMXL.MX")

# --- Rango de fechas (√∫ltimos 5 a√±os) ---
end = dt.date.today()
start = end - dt.timedelta(days=5 * 365)

if ticker:
    try:
        # Descargar datos diarios
        df = yf.download(ticker, start=start, end=end)

        if not df.empty:
            # Obtener √∫ltimo d√≠a h√°bil de cada mes
            df_monthly = df.resample('M').last()

            # Limpiar DataFrame
            df_monthly = df_monthly[['Close']].dropna()
            df_monthly.index = df_monthly.index.strftime("%Y-%m-%d")

            # Asegurar que el √∫ltimo valor sea escalar
            last_close = float(df_monthly["Close"].iloc[-1])
            last_date = df_monthly.index[-1]

            # Mostrar resultados
            st.success(f"**√öltimo d√≠a h√°bil mensual:** {last_date}")
            st.metric(label="üíµ Precio de cierre m√°s reciente", value=f"${last_close:,.2f}")

            # Mostrar gr√°fico mensual
            st.line_chart(df_monthly["Close"], use_container_width=True)

            # Mostrar tabla de datos mensuales
            with st.expander("üìÖ Ver datos mensuales"):
                st.dataframe(df_monthly.tail(12))

            # --- Generar CSV para descarga ---
            csv = df_monthly.to_csv().encode("utf-8")

            st.download_button(
                label="‚¨áÔ∏è Descargar datos mensuales en CSV",
                data=csv,
                file_name=f"{ticker}_cierres_mensuales.csv",
                mime="text/csv"
            )
        else:
            st.warning("No se encontraron datos para la clave de pizarra ingresada.")
    except Exception as e:
        st.error(f"Ocurri√≥ un error: {e}")
